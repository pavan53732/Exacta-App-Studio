# Unified Diff Contract & File Modification Rules

This document defines the only acceptable format for AI-generated code changes. It is authoritative for the diff parser and File Gateway.

---

## What Is a Diff
A **Diff** is a unified diff format specification of changes to a single file.
- Generated by AI based on plan step and context
- Validated by the diff parser before application
- Applied atomically by the File Gateway
- Reversible via rollback

---

## Accepted Unified Diff Format

The only accepted format is **standard unified diff**:

```

--- a/path/to/file.cs

+++ b/path/to/file.cs

@@ -10,6 +10,7 @@

context line

context line

-removed line

+added line

context line

```

### Required Elements

| Element | Requirement |
| --- | --- |
| Header line 1 | `--- a/{relative_path}` |
| Header line 2 | `+++ b/{relative_path}` |
| Hunk header | `@@ -{start},{count} +{start},{count} @@` |
| Context lines | Prefixed with single space |
| Removed lines | Prefixed with `-` |
| Added lines | Prefixed with `+` |
| Trailing newline | Required on final line |

### Hunk Header Format

```

@@ -<old_start>,<old_count> +<new_start>,<new_count> @@

```

- `old_start`: Line number where changes begin in original file
- `old_count`: Number of lines from original file in this hunk
- `new_start`: Line number where changes begin in new file
- `new_count`: Number of lines in new file after changes

---

## Forbidden Diff Constructs

The following cause **immediate rejection**:

| Construct | Reason |
| --- | --- |
| Markdown code fences (``` or `) | Parser ambiguity |
| Absolute paths (`C:\`, `/home/`) | Security boundary |
| Path traversal (`..`) | Escape attempt |
| Network paths (`\\server\`) | Security boundary |
| NUL bytes (`\x00`) | Binary content indicator |
| ANSI color codes | Parser corruption |
| Git-specific headers (`diff --git`) | Not standard unified diff |
| Binary diff markers | Binary files not supported |
| Combined diff format | Not supported |
| Context diff format (`*** / ---`) | Not supported |
| Side-by-side format | Not supported |

### Rejection Behavior
If any forbidden construct is detected:
1. Diff is rejected immediately
2. Error is logged with specific violation
3. User is informed
4. Single retry is offered with constraints reinforced in prompt

---

## Encoding Rules

### Accepted Encodings

| Encoding | Support |
| --- | --- |
| UTF-8 (with or without BOM) | Full |
| UTF-16 LE/BE | Full |
| ASCII | Full |
| Windows-1252 | Limited |

### Encoding Handling
1. File encoding is detected before diff generation
2. Encoding is recorded with the file
3. Diff must be generated in the same encoding as the target file
4. Encoding mismatch → Diff rejected

### Encoding Invariant
**Invariant:** Diffs never change file encoding. The output file has the same encoding as the input file.

---

## Binary File Handling

**Binary files cannot be modified via diff.**

### Binary Detection
A file is classified as binary if:
- MIME type detection indicates binary
- NUL bytes found in first 8KB
- File extension matches known binary types (`.exe`, `.dll`, `.png`, `.jpg`, etc.)

### Binary File Rules

| Operation | Allowed |
| --- | --- |
| Create (copy from template) | Yes |
| Delete (with confirmation) | Yes |
| Rename/Move | Yes |
| Modify via diff | **No** |

If AI generates a diff targeting a binary file, the diff is rejected.

---

## File Deletion Rules

### Deletion Format
File deletion is represented as:

```

--- a/path/to/file.cs

+++ /dev/null

@@ -1,N +0,0 @@

-line 1

-line 2

...

-line N

```

### Deletion Constraints

| Constraint | Requirement |
| --- | --- |
| One file per deletion step | Max 1 file deleted per step |
| Explicit confirmation required | User must approve deletion specifically |
| File must exist | Deleting non-existent file is an error |
| File must be in project root | No deletion outside sandbox |
| File must not match deny rules | Protected files cannot be deleted |

### Deletion Invariant
**Invariant:** File deletion is always a separate step requiring explicit confirmation. Deletion is never bundled with modifications.

---

## File Creation Rules

### Creation Format
File creation is represented as:

```

--- /dev/null

+++ b/path/to/newfile.cs

@@ -0,0 +1,N @@

+line 1

+line 2

...

+line N

```

### Creation Constraints

| Constraint | Requirement |
| --- | --- |
| Path must be relative | Absolute paths rejected |
| Path must be within project root | No creation outside sandbox |
| Parent directory must exist or be created | Missing parents cause rejection |
| File must not already exist | Creating over existing file is an error |
| Path must not match deny rules | Protected paths cannot have files created |

---

## File Rename Rules

### V1 Status
**File rename is not supported in V1.**

Rename operations must be decomposed into:
1. Create new file with content
2. Delete old file

This is explicit and auditable.

### Future Consideration
If rename support is added in future versions, it will:
- Require explicit rename syntax
- Require user confirmation
- Preserve file history metadata
- Be atomic (both paths updated together)

---

## Context Line Requirements

### Purpose of Context Lines
Context lines (unchanged lines surrounding changes) serve to:
1. Verify correct location in file
2. Detect drift between plan and current file state
3. Prevent application to wrong location

### Context Rules

| Rule | Requirement |
| --- | --- |
| Minimum context | 3 lines before and after (when available) |
| Maximum context | 10 lines before and after |
| Context must match exactly | Byte-for-byte match required |
| Whitespace is significant | Trailing spaces, tabs must match |

### Context Mismatch Behavior
If context lines do not match the target file:
1. Diff is rejected (no fuzzy matching)
2. File is re-read
3. Diff is regenerated with fresh context (single retry)
4. If retry fails, step is marked failed

---

## Rejection Conditions Summary

A diff is **rejected** if:

| Condition | Action |
| --- | --- |
| Invalid unified diff format | Reject |
| Forbidden construct detected | Reject |
| Path outside project root | Reject |
| Path traversal detected | Reject |
| Binary file targeted | Reject |
| Encoding mismatch | Reject |
| Context lines don't match | Reject (retry once) |
| Hunk line counts incorrect | Reject |
| Missing trailing newline | Reject |
| Multiple files in single diff | Reject |

---

## Validation Order

Diff validation proceeds in this order:

```

1. Format validation (is it valid unified diff?)
    
    │
    
    ▼
    
2. Path validation (relative, within root, no traversal?)
    
    │
    
    ▼
    
3. File type validation (not binary?)
    
    │
    
    ▼
    
4. Encoding validation (matches target?)
    
    │
    
    ▼
    
5. Context validation (lines match current file?)
    
    │
    
    ▼
    
6. Hunk validation (line counts correct?)
    
    │
    
    ▼
    
7. Apply atomically via File Gateway

```

Failure at any step halts validation. Later steps are not attempted.

---

## Security Boundary
**The diff parser is a security boundary.**

It is the last line of defense before file system mutation. Every diff from AI passes through this parser. No exceptions.

The parser assumes AI output is **untrusted** and validates accordingly.

---

## Hard Invariants
This component enforces the following Global System Invariants:
- **INV-GLOBAL-1: Local-Only Execution**
- **INV-GLOBAL-2: Deterministic Orchestration**
- **INV-GLOBAL-3: Fail-Closed Behavior**
- **INV-GLOBAL-4: AI Treated as Untrusted Input**
- **INV-GLOBAL-5: User-Owned API Keys**
- **INV-GLOBAL-6: No Telemetry