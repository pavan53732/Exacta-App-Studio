# Plan Validation Rules & Completeness Criteria

This document defines what makes a plan valid, complete, or invalid. It is authoritative for the Orchestrator's plan validation logic.

---

## What Is a Plan
A **Plan** is an ordered sequence of steps that, when executed, fulfills an intent.
- Generated by AI based on intent and project context
- Validated by the Orchestrator before user approval
- Immutable once approved
- Versioned; rejected plans increment the version number

---

## Plan Schema

```

Plan {

id: UUID                          [Required]

version: int                      [Required]

intent_id: UUID                   [Required]

status: PlanStatus                [Required]

steps: Step[]                     [Required]

constraints: Constraint[]         [Inherited from Intent]

created_at: ISO 8601 datetime     [Required]

approved_at: ISO 8601 datetime    [Set on approval]

}

```

### PlanStatus Values

| Status | Description |
| --- | --- |
| `Draft` | Generated, not yet validated |
| `Valid` | Passed validation, awaiting approval |
| `Approved` | User approved, ready for execution |
| `Executing` | Currently being executed |
| `Completed` | All steps executed successfully |
| `Failed` | Execution failed |
| `Cancelled` | User cancelled |
| `Invalid` | Failed validation, cannot be approved |

---

## Required Plan Elements

A valid plan must contain:

| Element | Requirement |
| --- | --- |
| `id` | Non-null UUID |
| `version` | Positive integer |
| `intent_id` | References a valid, extracted intent |
| `steps` | At least one step |
| `created_at` | Valid timestamp |

Missing any required element â†’ Plan is invalid.

---

## Step Schema

```

Step {

id: UUID                          [Required]

order: int                        [Required]

description: string               [Required]

target_files: string[]            [Required for file operations]

target_symbols: string[]          [Optional]

operation: OperationType          [Required]

dependencies: UUID[]              [Optional in V1]

constraints: Constraint[]         [Inherited]

status: StepStatus                [Required]

}

```

### OperationType Values

| Operation | Description |
| --- | --- |
| `Create` | Create a new file |
| `Modify` | Modify an existing file |
| `Delete` | Delete an existing file (requires confirmation) |
| `Build` | Invoke build toolchain |

---

## Validation Rules

### Structural Validation

| Rule | Failure Condition |
| --- | --- |
| All steps have unique IDs | Duplicate step ID found |
| Step order is sequential | Gaps or duplicates in order numbers |
| All target files are relative paths | Absolute path detected |
| No path traversal in targets | `..` detected in path |
| All target files within project root | Path resolves outside root |

---

### Ordering Rules

| Rule | Failure Condition |
| --- | --- |
| Steps are topologically sorted | Step references a dependency that comes later |
| No circular dependencies | Cycle detected in dependency graph |
| Dependencies reference valid step IDs | Dependency ID not found in plan |

**V1 Simplification:** Dependency graphs are not supported in V1. Plans must be linear (no dependencies between steps). If dependencies are detected, the plan is rejected.

---

### Limit Enforcement

| Limit | Maximum Value | Failure Behavior |
| --- | ---:| --- |
| Steps per plan | 10 | Reject plan |
| Files per step | 3 | Reject plan |
| Total files per plan | 15 | Reject plan |
| Diff size per step | 500 lines | Reject plan |
| Constraints per step | 10 | Reject plan |

Limits are **hard caps**. Exceeding any limit causes immediate rejection.

---

## Forbidden Steps

A plan is **invalid** if any step:

| Forbidden Action | Reason |
| --- | --- |
| Targets a file outside project root | Security boundary violation |
| Targets a binary file for modification | Diffs cannot represent binary changes |
| Deletes more than one file | Destructive; requires separate confirmation |
| Modifies build output directories | `bin/`, `obj/` are generated, not source |
| Modifies hidden directories | `.git/`, `.vs/` are infrastructure |
| Targets a file matching deny rules | User-configured restrictions |
| Has no target files (for file operations) | Incomplete specification |

---

## Completeness Criteria

A plan is **complete** only if it satisfies intent-specific checklists.

### CreateProject Completeness
- [ ] Project file created (`.csproj`, `.sln`)
- [ ] Entry point created (`Program.cs`, `App.xaml`)
- [ ] Main window created (for UI projects)
- [ ] Build configuration present

### AddFeature Completeness
- [ ] All required files identified
- [ ] UI component defined (if applicable)
- [ ] Business logic defined
- [ ] Integration points defined (if applicable)

### FixBug Completeness
- [ ] Bug location identified
- [ ] Fix approach specified
- [ ] Affected files identified

### BuildPackage Completeness
- [ ] Build configuration specified
- [ ] Output type specified
- [ ] No source modifications included

Incomplete plans are rejected with a message indicating what is missing.

---

## Cycle Detection

Cycles in step dependencies are **fatal errors**.

Detection algorithm:
1. Build directed graph from step dependencies
2. Perform topological sort
3. If sort fails (cycle exists), reject plan immediately

**V1:** Since dependencies are not supported, cycle detection is trivially satisfied.

---

## Conditions That Force Rejection

| Condition | Action |
| --- | --- |
| Any structural validation fails | Reject immediately |
| Any limit exceeded | Reject immediately |
| Any forbidden step detected | Reject immediately |
| Completeness criteria not met | Reject with explanation |
| Constraints violated by plan structure | Reject immediately |

---

## Conditions That Force Clarification

| Condition | Action |
| --- | --- |
| Target file is ambiguous | Ask user to specify |
| Multiple valid approaches exist | Ask user to choose |
| Constraint interpretation unclear | Ask user to confirm |

Clarification pauses plan generation. It does not reject the intent.

---

## Plan Versioning

| Event | Version Behavior |
| --- | --- |
| Initial generation | version = 1 |
| User requests changes | version increments |
| Validation failure + regeneration | version increments |
| User approves | version frozen |

Only one plan version may be active at a time. Previous versions are retained for audit but cannot be executed.

---

## Derived Plan Validation

When a user partially approves a plan (selecting a subset of steps), a **derived plan** is created. Derived plans have additional validation requirements.

### Derived Plan Requirements

| Requirement | Validation |
| --- | --- |
| All selected steps must have their dependencies also selected | Check each step's `dependencies[]`; reject if any dependency is not in selection |
| At least one step must be selected | Empty selection is rejected |
| Derived plan must pass all standard validation rules | Re-run structural, limit, and completeness validation |
| Step ordering must remain valid | Re-number steps sequentially; verify topological order preserved |

### Derived Plan Creation Process

```

1. User selects subset of steps from original plan
2. System extracts selected steps
3. System verifies all dependencies are satisfied within selection
    - If missing dependencies: REJECT with error listing missing steps
4. System creates new Plan object:
    - New UUID for id
    - version = 1
    - Same intent_id as original
    - steps = selected steps (re-ordered)
    - constraints = inherited from original
5. System runs full validation on derived plan
    - If validation fails: REJECT with validation errors
6. Derived plan presented for final confirmation
7. On approval: derived plan executes; original plan expires

```

### V1 Simplification
**V1:** Since dependencies between steps are not supported in V1, partial approval always succeeds dependency validation (trivially satisfied). Users may select any subset of steps.

---

## Hard Invariants
This component enforces the following Global System Invariants:
- **INV-GLOBAL-1: Local-Only Execution**
- **INV-GLOBAL-2: Deterministic Orchestration**
- **INV-GLOBAL-3: Fail-Closed Behavior**
- **INV-GLOBAL-4: AI Treated as Untrusted Input**
- **INV-GLOBAL-5: User-Owned API Keys**
- **INV-GLOBAL-6: No Telemetry