# D1. AI Interaction Pipeline Specification

This is the **Master Specification** for the AI Interaction Pipeline. It consolidates the logic for Intent Extraction, Constraint Propagation, Planning, Risk Assessment, and Validation.

> **Version:** V2 (Autonomous Agent)
> 

> **Status:** Canonical & Enforced
> 

> **Scope:** From user text input â†’ Validated, Risk-Assessed Plan
> 

> **Next Stage:** Gate Pipeline â†’ Safe Execution Engine
> 

---

## 1. Core Pipeline Invariants

- **INV-PIPE-1: Closed Taxonomy** â€” The system ONLY recognizes `CreateProject`, `AddFeature`, `FixBug`, and `BuildPackage`. All other intents are rejected.
- **INV-PIPE-2: Deterministic Risk** â€” Risk scoring (0-100) is deterministic based on file counts, deletions, and operation types.
- **INV-PIPE-3: Safety-Policy-First Approval** *(Changed in V2.2)* â€” All plans MUST pass the Approval Gate under Safety Policy ceilings enforced by the Guardian. No profile, risk score, or quality score MAY authorize execution if Safety Policy forbids the requested capabilities. SYSTEM-LEVEL plans MUST always require explicit human approval.
- **INV-PIPE-4: Constraints are First-Class** â€” User constraints (MUST/MUST_NOT) propagate from Intent â†’ Plan â†’ Step â†’ Validation.
- **INV-PIPE-5: Fail-Closed Validation** â€” Invalid plans (cycles, bad paths, missing steps) are rejected immediately.
- **INV-PIPE-7: Provider Lock-In** *(New in V2.2)* â€” Once Plan Generation begins, the selected provider/model SHALL NOT change. If the provider fails, the system MUST abort and request user confirmation before regenerating the plan with a different model.

---

## 2. Model Identity & Drift Control

<aside>
ğŸ”’

**INV-PIPE-6: Model Identity Tracking** *(New in V2.1)*

The system MUST track AI model identity across sessions. If model identity changes unexpectedly, execution MUST be blocked until the plan is regenerated with the new model.

</aside>

### Why Model Identity Matters

Autonomous systems make decisions based on AI output. If the underlying model changes (provider swaps weights, updates behavior, or substitutes a different model), plans generated by the old model may no longer be valid or safe.

### Model Identity Schema

```tsx
interface ModelIdentity {
  provider: string;           // e.g. "openai", "anthropic", "local"
  model_id: string;           // e.g. "gpt-4o", "claude-3-5-sonnet"
  model_version?: string;     // e.g. "2024-01-15" (if available)
  model_hash?: string;        // SHA-256 of model weights (if available, e.g. local models)
  capability_flags: {
    supports_streaming: boolean;
    supports_json_mode: boolean;
    supports_function_calling: boolean;
    max_context_tokens: number;
  };
}
```

### Session Recording

Every AI session MUST record:

| **Field** | **Source** | **Required** |
| --- | --- | --- |
| Provider | User configuration | Yes |
| Model ID | API response header or config | Yes |
| Model Version | API response header (if available) | No |
| Model Hash | Local model file hash | Only for local models |
| Capability Flags | Probed or configured | Yes |

### Drift Detection Rules

| **Change Detected** | **Severity** | **Action** |
| --- | --- | --- |
| Provider changed | HIGH | Block execution, require plan regeneration |
| Model ID changed | HIGH | Block execution, require plan regeneration |
| Model version changed | MEDIUM | Warn user, allow execution with confirmation |
| Capability flags changed | HIGH | Block execution, require plan regeneration |
| Model hash changed (local) | HIGH | Block execution, require plan regeneration |

### Plan-Model Binding

Every Plan is bound to the model that generated it:

```tsx
interface Plan {
  // ... existing fields ...
  
  // Model binding (V2.1)
  generated_by: {
    model_identity: ModelIdentity;
    session_id: string;
    timestamp: string;
  };
}
```

### Execution Gate

Before executing any plan step:

```jsx
Plan step ready for execution
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get current model identity          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Compare to plan.generated_by        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IF match: Proceed                   â”‚
â”‚ IF mismatch: Block + notify user    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### User Notification on Model Drift

When model identity changes:

```jsx
âš ï¸ AI Model Changed

The AI model has changed since this plan was generated.

Plan generated by: gpt-4o (2024-01-15)
Current model: gpt-4o (2024-02-01)

This plan may produce different results with the new model.

[Regenerate Plan] [Cancel]
```

---

## 3. AI Provider Layer (Contract)

The pipeline relies on a deterministic provider capability matrix.

### Capability Schema

All providers must match this capability interface:

```tsx
interface ProviderCapability {
  provider_id: string;             // e.g. "openai", "anthropic"
  model_id: string;                // e.g. "gpt-4o", "claude-3-5-sonnet"
  max_input_tokens: number;        // Context window hard limit
  supports_streaming: boolean;     // Required for Diff generation
  supports_json_mode: boolean;     // Required for Plan generation
  supports_function_calling: boolean; // Required for Intent extraction
}
```

### Selection & Fallback Strategy

1. **Intent Extraction:** Prefers lowest latency (e.g., `gpt-4o-mini`, `claude-3-haiku`).
2. **Plan Generation:** Prefers largest context/reasoning (e.g., `claude-3-5-sonnet`, `gpt-4o`).
3. **Fallback:** *(Changed in V2.2)* If a provider fails (5xx, timeout), the system attempts up to **3 retries** with exponential backoff **using the same provider/model**. Cross-provider fallback is NOT permitted during plan generation. If all retries fail, the system MUST abort and request user confirmation before attempting with a different model.

---

## 4. Step 1: Intent Extraction

Converts raw user text into a structured, validated command.

### Intent Taxonomy (Closed)

| Intent Type | Description | Required Context |
| --- | --- | --- |
| `CreateProject` | Initialize new project from template | Type (WPF/WinUI), Name, Path |
| `AddFeature` | Add new functionality | Feature Description |
| `FixBug` | Correct existing behavior | Bug Description, Location |
| `BuildPackage` | Compile/Package app | Build Config (Debug/Release) |

### Intent Schema

```tsx
interface Intent {
  id: UUID;
  correlation_id: UUID;          // Traces entire operation
  type: IntentType;
  confidence: number;            // 0.0 - 1.0
  target: {
    files: string[];             // Specific files mentioned
    symbols: string[];           // Specific classes/methods
  };
  constraints: Constraint[];     // Extracted requirements
}
```

### Confidence Gates

- **â‰¥ 0.85 (High):** Proceed to Planning automatically.
- **0.60 - 0.84 (Medium):** **STOP.** Ask user to confirm interpretation.
- **< 0.60 (Low):** **REJECT.** Ask user to rephrase.

---

## 5. Step 2: Constraint Propagation

Constraints are strict boundaries that survive the entire pipeline.

### Constraint Schema

```tsx
interface Constraint {
  type: 'MUST' | 'MUST_NOT' | 'PREFER';
  scope: 'global' | 'file' | 'step';
  description: string; // e.g. "Do not use third-party libraries"
}
```

### Propagation Rules

1. **Extraction:** Constraints extracted from user prompt.
2. **Injection:** Constraints injected into System Prompt for Plan Generation.
3. **Validation:** Plan steps validated against `MUST_NOT` constraints.
4. **Execution:** If a constraint is violated during diff generation, the step is rejected.

---

## 6. Step 3: Planning & Risk Assessment

Converts an Intent into an ordered list of execution steps (`Plan`).

### Plan Schema

```tsx
interface Plan {
  id: UUID;
  intent_id: UUID;
  risk_score: number;       // 0-100
  quality_score: number;    // 0.0-1.0
  status: 'pending' | 'approved' | 'rejected';
  steps: PlanStep[];
}

interface PlanStep {
  type: 'create' | 'modify' | 'delete' | 'build';
  target_file: string;
  description: string;
  constraints: Constraint[];
}
```

### Risk Assessment (Scoring Table)

The **Agent Controller** calculates `risk_score` (0-100) using these weights:

> **Cross-Reference (V2.2):** Risk score MUST incorporate **Policy Boundary Impact** as defined in B2. Any non-zero boundary impact SHALL elevate the plan to High Risk (â‰¥66).
> 

| Factor | Weight | Criteria |
| --- | --- | --- |
| **File Operations** | 0-35 pts | Deletions (+10), Bulk Modifies (>5 files +15) |
| **Dependency Changes** | 0-25 pts | Adding/Removing external packages |
| **Refactoring** | 0-20 pts | Cross-file changes, renames |
| **Breaking Changes** | 0-15 pts | Public API signature changes |
| **Security Impact** | 0-15 pts | Touching Auth/Crypto/Secrets |
| **Complexity** | 0-10 pts | Cyclomatic complexity estimate |

### Quality Scoring

- **Completeness (30%):** Does it cover the Intent?
- **Specificity (25%):** Are paths/symbols explicit?
- **Feasibility (20%):** Do files exist?
- **Safety (15%):** Are dangerous patterns avoided?
- **Clarity (10%):** Is the description readable?

### Approval Flow (V2 - Gate Pipeline)

Plans now flow through the **Gate Pipeline** instead of a simple decision tree:

```jsx
Plan â†’ Security Gate â†’ Policy Gate â†’ Risk Gate â†’ Quality Gate â†’ [User Confirm if needed]
```

**Gate Pipeline Outcomes:**

- **ALLOW:** Policy permits. Execute immediately.
- **DENY:** Policy forbids or quality too low. Block.
- **CONFIRM:** User must approve (high risk, moderate quality, or profile requires).

**Decision by Profile:**

| Condition | PROFILE-SAFE | PROFILE-DEV | PROFILE-FULL-AUTO |
| --- | --- | --- | --- |
| Quality < 0.60 | DENY | DENY | DENY |
| Risk > 65 (High) | CONFIRM | CONFIRM | CONFIRM |
| Quality 0.60-0.74 + Risk > 30 | CONFIRM | CONFIRM | **ALLOW** |
| Risk â‰¤ 65 + Quality â‰¥ 0.75 | CONFIRM | **ALLOW** | **ALLOW** |

**See:** Approval Gate Specification, Autonomy Profiles & Policy Engine

---

## 7. Step 4: Plan Validation Rules

Before a plan can be assessed for risk, it must pass structural validation.

### Critical Validation Rules (PV-Series)

- **PV-1 (Structure):** Plan MUST have at least one step.
- **PV-2 (Target):** All target paths MUST be within Project Root (Sandbox).
- **PV-3 (Flow):** Dependency graph MUST be acyclic (Linear for V1).
- **PV-4 (Limits):** Max 10 steps, Max 15 files touched total.
- **PV-5 (Safety):** NO binary file modifications allowed via Diff.

### Completeness Checklists (by Intent)

- **AddFeature:** Must define UI component (if needed) + Business Logic + Data wiring.
- **FixBug:** Must identify bug location + fix approach + regression check.
- **CreateProject:** Must create `.csproj` + Entry point (`Program.cs`) + Build config.

If validation fails, the system attempts **Auto-Regeneration** (up to 3 times) with the error context before failing to the user.

---

## Hard Invariants

This component enforces the following Global System Invariants:

- **INV-GLOBAL-1: Local-Only Execution**
- **INV-GLOBAL-2: Policy-Based Approval Gate**
- **INV-GLOBAL-5: AI Treated as Untrusted Input**
- **INV-GLOBAL-9: Complete Audit Trail**